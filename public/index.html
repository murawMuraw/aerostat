<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Карта с кругом и ветром</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <style>
    html, body, #map { width:100%; height:100%; margin:0; padding:0; }
    #windInfo, #pathInfo {
      position:absolute; left:10px; padding:10px;
      background:rgba(255,255,255,0.9); z-index:1000;
      font-family:sans-serif; font-size:14px; white-space:pre-line;
    }
    #windInfo { top:10px; }
    #pathInfo { top:70px; }
  </style>
</head>
<body>

<div id="windInfo">Скорость и направление ветра</div>
<div id="pathInfo">Длина пути: 0 км</div>
<div id="map"></div>

<script>
  const apiKey = '080b3dab3f26f4e8d44b5d87f4c3ee78';
  let map, circle, arrow, historyLine;
  let moveTimer = null, windTimer = null;
  const path = [];
  let currentWind = { speed: 0, deg: 0 };

  function getWindData(lat, lon) {
    return fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`)
      .then(res => res.json())
      .then(data => ({ speed: data.wind.speed, deg: data.wind.deg }));
  }

  function haversineDistance(coord1, coord2) {
    const R = 6371;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(coord2[0] - coord1[0]);
    const dLon = toRad(coord2[1] - coord1[1]);
    const lat1 = toRad(coord1[0]);
    const lat2 = toRad(coord2[0]);
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  ymaps.ready(() => {
    map = new ymaps.Map("map", { center:[51.5,0.0], zoom:5 });

    map.events.add('click', async function(e) {
      const coords = e.get('coords');

      if (circle) {
        map.geoObjects.remove(circle);
        map.geoObjects.remove(arrow);
        map.geoObjects.remove(historyLine);
        clearInterval(moveTimer);
        clearInterval(windTimer);
        path.length = 0;
      }

      circle = new ymaps.Circle([coords,10000], {}, {
        fillColor:"#87CEEB", fillOpacity:0.15,
        strokeColor:"#87CEEB", strokeWidth:2, strokeOpacity:0.6
      });
      map.geoObjects.add(circle);

      arrow = new ymaps.Placemark(coords, {}, {
        preset:'islands#redArrowIcon',
        iconRotate:true,
        iconRotation:0
      });
      map.geoObjects.add(arrow);

      historyLine = new ymaps.Polyline([], {}, {
        strokeColor:"#0000FF", strokeWidth:2, strokeOpacity:0.6
      });
      map.geoObjects.add(historyLine);

      startMoving();
    });
  });

  function startMoving() {
    const updateWind = async () => {
      const [lat, lon] = circle.geometry.getCoordinates();
      try {
        const wind = await getWindData(lat, lon);
        currentWind = wind;
        document.getElementById('windInfo').innerText =
          `Скорость ветра: ${wind.speed.toFixed(1)} м/с\nНаправление: ${wind.deg}°`;
      } catch(e) {
        console.error(e);
        document.getElementById('windInfo').innerText = "Ошибка получения данных ветра";
      }
    };

    updateWind();
    windTimer = setInterval(updateWind, 60000);

    moveTimer = setInterval(() => {
      const [lat, lon] = circle.geometry.getCoordinates();
      const angleRad = ((currentWind.deg)%360)*Math.PI/180;
      const dx = currentWind.speed*Math.sin(angleRad);
      const dy = -currentWind.speed*Math.cos(angleRad);
      const newLat = lat + (dy/111320);
      const newLon = lon + (dx/(40075000*Math.cos(lat*Math.PI/180)/360));
      const newCoords = [newLat, newLon];

      circle.geometry.setCoordinates(newCoords);
      arrow.geometry.setCoordinates(newCoords);
      arrow.options.set('iconRotation', currentWind.deg);

      path.push(newCoords);
      historyLine.geometry.setCoordinates(path);

      let totalDistance = 0;
      for (let i = 1; i < path.length; i++) {
        totalDistance += haversineDistance(path[i - 1], path[i]);
      }
      document.getElementById('pathInfo').innerText = `Длина пути: ${totalDistance.toFixed(2)} км`;
    }, 1000);
  }
</script>
</body>
</html>
